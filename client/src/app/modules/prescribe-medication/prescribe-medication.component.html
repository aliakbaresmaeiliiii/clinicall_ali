<section class="w-full">
  <mat-card appearance="outlined" class="p-4">
    <form [formGroup]="form" (ngSubmit)="onSubmit(form.value)" class="mt-4">
      <generic-tab
        [tabs]="tabs"
        (selectedIndexChange)="handleTabChange($event)">
        <ng-template #templateOne let-data="data" formArrayName="patientInfo">
          <div class="p-5">
            <h2 class="text-3xl font-medium">{{ title() }}</h2>

            <div class="desktop:grid grid-cols-4 gap-3">
              <!-- *****Patient Name***** -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-select
                  name="patientName"
                  formControlName="patientName"
                  placeholder="selected Patient...">
                  <input
                    type="text"
                    placeholder="Pick up patient..."
                    (input)="filterPatient()"
                    style="width: 100%; padding: 8px; margin-bottom: 8px" />
                  <mat-option
                    *ngFor="let p of filteredPatient"
                    [value]="p.patientName"
                    (onSelectionChange)="onSelectedChange(p)">
                    {{ p.patientName }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <!-- *****Date of birth***** -->
              <mat-form-field
                data-testing="department"
                appearance="outline"
                class="w-full">
                <mat-label>Date Of Birth</mat-label>
                <input
                  type="text"
                  matInput
                  [errorStateMatcher]="matcher"
                  formControlName="dateOfBirth" />
              </mat-form-field>

              <!-- *****bloodGroup***** -->
              <mat-form-field
                data-testing="department"
                appearance="outline"
                class="w-full">
                <mat-label>bloodGroup</mat-label>
                <input
                  type="text"
                  matInput
                  [errorStateMatcher]="matcher"
                  formControlName="bloodGroup" />
              </mat-form-field>

              <!-- *****bloodPressure***** -->
              <mat-form-field
                data-testing="department"
                appearance="outline"
                class="w-full">
                <mat-label>bloodPressure</mat-label>
                <input
                  type="text"
                  matInput
                  [errorStateMatcher]="matcher"
                  formControlName="bloodPressure" />
              </mat-form-field>

              <!-- *****haemoglobin***** -->
              <mat-form-field
                data-testing="department"
                appearance="outline"
                class="w-full">
                <mat-label>haemoglobin</mat-label>
                <input
                  type="text"
                  matInput
                  [errorStateMatcher]="matcher"
                  formControlName="haemoglobin" />
              </mat-form-field>

              <!-- *****mobile***** -->
              <mat-form-field
                data-testing="department"
                appearance="outline"
                class="w-full">
                <mat-label>mobile</mat-label>
                <input
                  type="text"
                  matInput
                  [errorStateMatcher]="matcher"
                  formControlName="mobile" />
              </mat-form-field>

              <!-- *****sugarLevel***** -->
              <mat-form-field
                data-testing="department"
                appearance="outline"
                class="w-full">
                <mat-label>sugarLevel</mat-label>
                <input
                  type="text"
                  matInput
                  [errorStateMatcher]="matcher"
                  formControlName="sugarLevel" />
              </mat-form-field>
              <!-- *****Diseases***** -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Selected Diseases...</mat-label>
                <mat-select name="selectedDiseases" formControlName="diseases">
                  <input
                    type="text"
                    placeholder="Pick up Diseases..."
                    (input)="filterDiseases()"
                    style="width: 100%; padding: 8px; margin-bottom: 8px" />
                  <mat-option
                    *ngFor="let p of filteredDiseases"
                    [value]="p.name"
                    (onSelectionChange)="
                      onSelectedChangeDiseases(p.disease_id)
                    ">
                    {{ p.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <!-- *****disease_subcategories***** -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Selected SubCategoriesDisease...</mat-label>

                <mat-select
                  name="SubCategoriesDisease"
                  formControlName="diseaseSubcategories"
                  [disabled]="isSelectDisease">
                  <input
                    type="text"
                    placeholder="Pick up SubCategoriesDisease..."
                    (input)="filterSubCategoriesDisease()"
                    style="width: 100%; padding: 8px; margin-bottom: 8px" />
                  <mat-option
                    *ngFor="let p of filteredSubCategoriesDisease"
                    (onSelectionChange)="onSelectedChangeSubCat(p)"
                    [value]="p.name">
                    {{ p.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <!-- *****Severity***** -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Severity</mat-label>
                <mat-select
                  [disabled]="isSelectedSubCategory"
                  formControlName="severity">
                  @for (s of severityData; track s) {
                  <mat-option [value]="s.value">{{ s.viewValue }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <div class="desktop:grid grid-cols-2 gap-3 desktop:mt-10 mb-2">
              <!-- *****CancelBTN***** -->
              <button mat-stroked-button type="button" (click)="form.reset()">
                Cancel
              </button>
              <!-- *****SaveBTN***** -->
              <button
                class="desktop:m-0 tablet:mt-2 mobile:mt-2"
                mat-flat-button
                data-testid="login-button"
                type="button"
                (click)="storeDataTemp1()">
                Next Step
              </button>
            </div>
          </div>
        </ng-template>

        <ng-template #templateTwo let-data="data" formGroupName="medication">
          <div class="mt-4">
            <h2 class="text-3xl font-medium">Precription Medicine</h2>
            <div class="desktop:grid grid-cols-4 gap-3 pt-4 p-5">
              <!-- *****Medicine***** -->
              <ali-select
                label="Pick the Medicine"
                multiple
                [searchable]="true"
                [compareWith]="compareWithFn"
                [displayWith]="displayWithFn"
                formControlName="medicine"
                (closed)="onSearchChanged('')"
                (searchChanged)="onSearchChanged($event)">
                <div class="w-[300px]">
                  @for (medic of filterMedicData; track $index) {
                  <app-option [value]="medic" class="w-full">
                    <div class="flex justify-between items-center w-full">
                      <div>
                        <i class="fa-solid fa-tablets text-blue-600"></i>
                        {{ medic.name }}
                      </div>
                      <div
                        (click)="
                          $event.stopPropagation(); selectedFavorite(medic)
                        ">
                        <i
                          matTooltip="Add favorite"
                          class="fa-solid fa-star"
                          [ngClass]="{
                            'text-yellow-400': medic.isFavorite,
                            'text-gray-400': !medic.isFavorite
                          }"></i>
                      </div>
                    </div>
                  </app-option>
                  }
                </div>
              </ali-select>
              <!-- *****Duration***** -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Duration</mat-label>
                <mat-select formControlName="duration">
                  @for (d of durationOption; track d) {
                  <mat-option [value]="d.value">{{ d.viewValue }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <!-- *****frequencyOptions***** -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>frequencyOptions</mat-label>
                <mat-select
                  formControlName="frequency"
                  (selectionChange)="onFrequencyChange($event)">
                  @for (d of frequencyOptions; track d) {
                  <mat-option [value]="d.value">{{ d.viewValue }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              @if (frequency?.value === 'custom') {
              <mat-form-field appearance="outline">
                <mat-label>Custom Frequency</mat-label>
                <input
                  matInput
                  formControlName="customFrequency"
                  placeholder="Enter custom frequency" />
              </mat-form-field>
              }
              <!-- *****prescription_date***** -->
              <mat-form-field appearance="outline" class="w-full mb-1">
                <mat-label>prescription_date</mat-label>
                <input
                  [max]="maxDate"
                  [min]="minDate"
                  matInput
                  [matDatepicker]="picker"
                  formControlName="prescription_date" />
                <!-- <mat-hint>MM/DD/YYYY</mat-hint> -->
                <mat-datepicker-toggle matIconSuffix [for]="picker">
                  <mat-icon matDatepickerToggleIcon
                    >keyboard_arrow_down</mat-icon
                  >
                </mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>
            </div>

            <div class="p-5">
              <!-- *****description***** -->
              <mat-form-field
                data-testing="department"
                appearance="outline"
                class="w-full">
                <mat-label>description</mat-label>
                <textarea
                  matInput
                  placeholder="Ex. It makes me feel..."
                  formControlName="description"></textarea>
              </mat-form-field>
            </div>
          </div>
          <div class="desktop:grid grid-cols-2 gap-3 desktop:mt-10 mb-2">
            <!-- *****CancelBTN***** -->
            <button mat-stroked-button type="button" (click)="form.reset()">
              Cancel
            </button>
            <!-- *****SaveBTN***** -->
            <button
              [disabled]="!form.valid"
              class="desktop:m-0 tablet:mt-2 mobile:mt-2"
              mat-flat-button
              data-testid="login-button"
              type="button"
              (click)="storeDataTemp2()">
              Save
            </button>
          </div>
          <div class="h-80 overflow-auto">
            @if (formData()) { @for (item of storeMedicine; track item ) {
            <div
              class="flex justify-between gap-3 p-4 border-2 border-dashed rounded-lg mt-5">
              <div class="flex flex-col">
                <ng-container class="p-2">
                  <div class="flex">
                    <span class="opacity-55 pr-2">Diseases:</span>
                    <pre>{{ formData().patientInfo()?.patientName }}</pre>
                  </div>
                  <div>
                    <span class="opacity-55">DiseaseSubcategories:</span>
                    <span class="pl-1">{{
                      item.medication.diseaseSubcategories
                    }}</span>
                  </div>
                  <div>
                    <span class="opacity-55">Severity:</span>
                    <span class="pl-1">{{ item.medication.severity }}</span>
                  </div>
                  <div class="flex">
                    <span class="opacity-55"> Medicine: </span>

                    @for (m of item.medication.medicine; track $index ) {
                    <div class="flex">
                      <span class="pl-1">
                        {{ m.medicine_name }}
                        <span
                          *ngIf="$index < item.medication.medicine.length - 1"
                          >,</span
                        ></span
                      >
                    </div>
                    }
                  </div>

                  <div>
                    <span class="opacity-55">Duration:</span>
                    <span class="pl-1">{{ item.medication.duration }}</span>
                  </div>
                  <div>
                    <span class="opacity-55">Frequency:</span>
                    <span class="pl-1">{{ item.medication.frequency }}</span>
                  </div>

                  @if (item.medication.frequencyOption) {
                  <div>
                    <span class="opacity-55">Frequency Option:</span>
                    <span class="pl-1">{{
                      item.medication.frequencyOption
                    }}</span>
                  </div>
                  }
                  <div>
                    <span class="opacity-55">Prescription Date:</span>
                    <span class="pl-1">{{
                      item.medication.prescription_date | date
                    }}</span>
                  </div>
                </ng-container>
              </div>

              <div>
                <button
                  class="pointer"
                  matTooltip="Delete Medicine"
                  mat-icon-button
                  type="button"
                  (click)="deleteMedicine(item)">
                  <i class="fa-regular fa-trash-can text-red-500 text-xl"></i>
                </button>
                <button
                  class="pointer"
                  mat-icon-button
                  type="button"
                  matTooltip="Eidt Doctor"
                  (click)="openDialogEdit()">
                  <i
                    class="fa-solid fa-pen-to-square text-blue-500 text-xl"></i>
                </button>
              </div>
            </div>
            }@empty { There is no items. } }
          </div>
        </ng-template>

        <ng-template #templateThree let-data="data">
          @if (storeMedicine.length) { @for (item of storeMedicine; track item)
          {
          <div class="border-2 p-4 rounded-md mt-2">
            <ng-container class="p-4 border-2 border-dashed rounded-lg mt-5 p">
              <!-- Patient Information -->
              <div class="text-2xl font-medium py-6 opacity-50">
                Patient Information
              </div>
              <div
                class="grid md:grid-cols-2 lg:grid-cols-3 grid-cols-4 gap-4 pb-2">
                <div>
                  <span class="opacity-55">Patient Name:</span>
                  <span class="pl-1">{{ item.patientName }}</span>
                </div>
                <div>
                  <span class="opacity-55">Sugar Level:</span>
                  <span class="pl-1">{{ item.sugarLevel }}</span>
                </div>
                <div>
                  <span class="opacity-55">Mobile:</span>
                  <span class="pl-1">{{ item.mobile }}</span>
                </div>
                <div>
                  <span class="opacity-55">Haemoglobin:</span>
                  <span class="pl-1">{{ item.haemoglobin }}</span>
                </div>
                <div>
                  <span class="opacity-55">Date of Birth:</span>
                  <span class="pl-1">{{ item.dateOfBirth }}</span>
                </div>
                <div>
                  <span class="opacity-55">Blood Pressure:</span>
                  <span class="pl-1">{{ item.bloodPressure }}</span>
                </div>
              </div>

              <hr />
              <!-- Prescription Medicine -->
              <div class="text-2xl font-medium py-6 opacity-50">Disease</div>
              <div
                class="grid md:grid-cols-2 lg:grid-cols-3 grid-cols-4 gap-4 pb-2">
                @if (storeMedicine.length) { @for (item of storeMedicine; track
                item ) {

                <div>
                  <span class="opacity-55">Diseases:</span>
                  <span class="pl-1">{{ item.medication.diseases }}</span>
                </div>
                <div>
                  <span class="opacity-55">DiseaseSubcategories:</span>
                  <span class="pl-1">{{
                    item.medication.diseaseSubcategories
                  }}</span>
                </div>
                <div>
                  <span class="opacity-55">Severity:</span>
                  <span class="pl-1">{{ item.medication.severity }}</span>
                </div>

                }@empty { There is no items. } }
              </div>

              <hr />
              <!-- Prescription Medicine -->
              <div class="text-2xl font-medium py-6 opacity-50">
                Prescription Medicine
              </div>
              <div class="grid md:grid-cols-2 lg:grid-cols-3 grid-cols-2 gap-4">
                <div class="flex w-36 flex-wrap">
                  <span class="opacity-55"> Medicine: </span>
                  @for (m of item.medication.medicine; track $index ) {
                  <div class="flex">
                    <span class="pl-1">
                      {{ m.medicine_name }}
                      <span *ngIf="$index < item.medication.medicine.length - 1"
                        >,</span
                      ></span
                    >
                  </div>
                  }
                </div>

                <div>
                  <span class="opacity-55">Duration:</span>
                  <span class="pl-1">{{ item.medication.duration }}</span>
                </div>
                <div>
                  <span class="opacity-55">Frequency:</span>
                  <span class="pl-1">{{ item.medication.frequency }}</span>
                </div>

                @if (item.medication.frequencyOption) {
                <div>
                  <span class="opacity-55">Frequency Option:</span>
                  <span class="pl-1">{{
                    item.medication.frequencyOption
                  }}</span>
                </div>
                }
                <div>
                  <span class="opacity-55">Prescription Date:</span>
                  <span class="pl-1">{{
                    item.medication.prescription_date | date
                  }}</span>
                </div>
              </div>
            </ng-container>
          </div>

          } @empty {
          <p>There are no items to display.</p>
          } }
          <div class="desktop:grid grid-cols-2 gap-3 desktop:mt-10 mb-2">
            <!-- *****CancelBTN***** -->
            <button mat-stroked-button type="button" (click)="form.reset()">
              Cancel
            </button>
            <!-- *****SaveBTN***** -->
            <button
              class="desktop:m-0 tablet:mt-2 mobile:mt-2"
              mat-flat-button
              data-testid="login-button"
              type="submit">
              Final Save
            </button>
          </div>
          <!-- {{ formData().medication| json }} -->
          <br />
          <div>
            <strong>PatientInfo</strong> :{{
              formData().patientInfo.patientName | json
            }}
          </div>
          <div>
            <strong>Medication</strong> :
            {{ formData().medication.duration | json }}
          </div>
        </ng-template>
      </generic-tab>
    </form>
  </mat-card>
</section>
